# Go Kubernetes & Helm Client Project

## Overview

This project is a Go application that demonstrates interaction with Kubernetes clusters and Helm chart deployments. It includes:

- CLI tools:
  - **k8schecker**: verify cluster state & permissions
  - **helmctl**: manage Helm releases (install, list, uninstall)
  - **configloader**: one-time loader for `.conf` defaults
  - **backupctl**: manage Helm release backups (create, list, restore, prune)
- Internal utility packages:
  - **internal/k8sutils**
  - **internal/helmutils**
  - **internal/configloader**
  - **internal/backupmanager**: core logic for chart backup and restore
- Example Helm charts generated by `scripts/generate_sample_charts.py` for testing.
- An older example Helm chart in `umbrella-chart/` (can be used for basic environment testing).

## Prerequisites

1. Go 1.18+
2. Kubernetes cluster (Minikube, Kind, Docker Desktop, or cloud)
3. Helm v3 CLI
4. kubectl configured for your cluster
5. Python 3.x (to run `generate_sample_charts.py`)
6. Docker (optional—container builds)

## Getting Started

1. Clone the repo and `cd` into it.
2. Build the CLIs. You can build them individually or use the Makefile:

   **Build all using Makefile:**
   ```bash
   make build-all
   ```

   **Build individually:**
   ```bash
   go build -o ./bin/k8schecker ./cmd/k8schecker
   go build -o ./bin/helmctl    ./cmd/helmctl
   go build -o ./bin/configloader ./cmd/configloader
   go build -o ./bin/backupctl ./cmd/backupctl
   ```

3. Generate sample charts for testing:
   ```bash
   make gen-work # Generates working charts with resolved values
   # OR
   make gen-placeholder # Generates charts with @{variable} placeholders
   ```
   The generated charts will be in `data/charts/working_charts/` or `data/charts/placeholder_charts/`.

4. Run any CLI with `--help` for usage examples. For example:
   ```bash
   ./bin/backupctl --help
   ```

## Project Structure

```bash
.
├── bin/
│   ├── k8schecker
│   ├── helmctl
│   ├── configloader
│   └── backupctl          # CLI for backup operations
├── cmd/
│   ├── k8schecker/        # CLI for K8s checks
│   ├── helmctl/           # CLI for Helm operations
│   ├── configloader/      # CLI to load .conf defaults
│   └── backupctl/         # CLI for backup operations
├── internal/
│   ├── k8sutils/          # K8s client & auth helpers
│   ├── helmutils/         # Helm SDK wrappers
│   ├── configloader/      # .conf parsing & variable resolution
│   └── backupmanager/     # Core logic for chart backup & restore
├── scripts/
│   └── generate_sample_charts.py # Script to generate sample Helm charts
├── umbrella-chart/        # Older example chart for testing
├── data/                  # Persistent application data
│   ├── charts/            # Root for generated sample charts
│   │   ├── working_charts/
│   │   └── placeholder_charts/
│   ├── backups/           # `backupctl` default output
│   ├── config/            # `configloader` default output:
│   │   └── all_variables.json
│   ├── database/
│   └── public/            # (future)
├── Dockerfile             # (future)
├── deployment.yaml        # (future)
├── go.mod
├── go.sum
├── Makefile               # Build and utility scripts
├── TODO.md
└── README.md
```

## Data Management

At runtime, the application uses `./data/` (or a custom path) to store:

- `charts/` – Root directory for sample Helm charts generated by `scripts/generate_sample_charts.py`.
- `backups/` – Helm release backups managed by `backupctl`.
- `config/` – Application `.conf` files & `all_variables.json` (output of `configloader`).
- `database/` – SQLite database file (if used).
- `public/` – Compiled static assets (future).

Ensure these directories exist or are auto-created. In Kubernetes, map `./data` to a PersistentVolume.

## Command-Line Utilities

### k8schecker

Interact with Kubernetes and verify permissions.
```bash
./bin/k8schecker --help
```

### helmctl

Manage Helm releases programmatically (install, list, uninstall).
```bash
./bin/helmctl <command> --help
```

### configloader

One-time loader for `.conf` defaults.
(Details as before)
...

### backupctl

Manages backups of Helm releases, allowing for creation, listing, restoration, and pruning of backups. It uses the `internal/backupmanager` for its core logic.

**Build (if not using `make build-all`):**
```bash
go build -o ./bin/backupctl ./cmd/backupctl
```

**Usage:**
```bash
./bin/backupctl --help
./bin/backupctl backup --chart-path ./data/charts/working_charts/appstack-alpha --values ./data/charts/working_charts/appstack-alpha/values.yaml my-release-alpha
./bin/backupctl list my-release-alpha
./bin/backupctl restore my-release-alpha <backup-id> --namespace my-namespace
```
Default backup directory is `./chart_backups`. This can be changed with the global `--backup-dir` flag.

## Internal Modules

### internal/k8sutils

Helpers for Kubernetes client, in-cluster vs kubeconfig, and auth checks.

### internal/helmutils

Wrappers around Helm SDK for installs, upgrades, repos, etc.

### internal/configloader

Parses and resolves `.conf` files with variable substitution and grouping.

### internal/backupmanager

Provides the core logic for creating, managing, and restoring versioned backups of Helm charts and their associated values. See `internal/backupmanager/readme_cn.md` for a detailed explanation (in Chinese).

## Generating and Testing with Sample Charts

The `scripts/generate_sample_charts.py` script is provided to create sample umbrella Helm charts for testing various functionalities, especially `backupctl`.

**Generate charts:**
```bash
# For charts with resolved values (recommended for direct deployment testing)
python3 scripts/generate_sample_charts.py --version-type working

# For charts with @{variable} placeholders (for template processing tests)
python3 scripts/generate_sample_charts.py --version-type placeholder
```
Or use the Makefile targets: `make gen-work` or `make gen-placeholder`.

The generated charts will be in `data/charts/working_charts/` or `data/charts/placeholder_charts/`. Each umbrella chart (e.g., `appstack-alpha`) will contain its subcharts within its `charts/` directory.

**Example: Test backup and restore with a generated chart:**
```bash
# 1. Generate working charts
make gen-work

# 2. Define some variables for convenience
CHART_PATH="./data/charts/working_charts/appstack-alpha"
RELEASE_NAME="alpha-test"
NAMESPACE="dev" # Ensure this namespace exists or use --create-namespace

# 3. Create a backup
./bin/backupctl backup --chart-path $CHART_PATH $RELEASE_NAME --values $CHART_PATH/values.yaml

# 4. List backups to get a <backup-id>
./bin/backupctl list $RELEASE_NAME
# Note the backup ID from the output

# 5. (Optional) Install the chart normally to simulate an existing release
# helm install $RELEASE_NAME $CHART_PATH -n $NAMESPACE --create-namespace

# 6. Restore from backup (replace <backup-id> with actual ID)
# ./bin/backupctl restore $RELEASE_NAME <backup-id> --namespace $NAMESPACE --create-namespace --wait

# 7. (Optional) Clean up
# helm uninstall $RELEASE_NAME -n $NAMESPACE
# ./bin/backupctl delete $RELEASE_NAME <backup-id>
# make clean-data # To remove all generated charts
```

## Makefile Targets

The `Makefile` provides convenience targets:
```makefile
# Build all CLI binaries
build-all:
    @echo "Building all CLI tools..."
    go build -o ./bin/k8schecker ./cmd/k8schecker
    go build -o ./bin/helmctl    ./cmd/helmctl
    go build -o ./bin/configloader ./cmd/configloader
    go build -o ./bin/backupctl ./cmd/backupctl

# Clean generated chart data
clean-data:
    @echo "Removing generated chart data..."
    rm -rf data/charts/*

# Generate placeholder charts
gen-placeholder:
    @echo "Generating placeholder chart data..."
    @python3 scripts/generate_sample_charts.py --version-type placeholder

# Generate working charts
gen-work:
    @echo "Generating working chart data..."
    @python3 scripts/generate_sample_charts.py --version-type working

.PHONY: build-all clean-data gen-placeholder gen-work
```

## Future Enhancements
(As before)

## Contributing
(As before)

## License
(As before)
